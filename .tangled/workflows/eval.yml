# SPDX-FileCopyrightText: 2025 FreshlyBakedCake
#
# SPDX-License-Identifier: MIT
when:
  - event: ["push", "pull_request"]
    branch: ["main", "test"]

dependencies:
  nixpkgs:
    - lix
    - gnugrep

steps:
  - name: Evaluate all systems
    command: |
      set +e
      set -o pipefail

      eval_out=$(nix-instantiate ./nilla.nix -A packages.allNixOSSystems.result.x86_64-linux --add-root ./system-root 2>&1 | tee /dev/stderr)
      eval_status=$?

      if [ $eval_status -ne 0 ]; then
        echo "Evaluating your configuration failed with exit code $eval_status"
        echo "Please fix this and squash into your existing commits"
        exit $eval_status
      fi

      eval_warns=$(echo "$eval_out" | grep "evaluation warning:" || true)

      if [ -n "$eval_warns" ]; then
        echo "There were some warnings while evaluating your systems:"
        echo "$eval_warns"
        echo "Please fix these and squash into your existing commits"
        exit 1
      fi
  - name: Evaluate all homes
    command: |
      set +e
      set -o pipefail

      eval_out=$(nix-instantiate ./nilla.nix -A packages.allNixOSSystems.result.x86_64-linux --add-root ./system-root 2>&1 | tee /dev/stderr)
      eval_status=$?

      if [ $eval_status -ne 0 ]; then
        echo "Evaluating your configuration failed with exit code $eval_status"
        echo "Please fix this and squash into your existing commits"
        exit $eval_status
      fi

      eval_warns=$(echo "$eval_out" | grep "evaluation warning:" || true)

      if [ -n "$eval_warns" ]; then
        echo "There were some warnings while evaluating your systems:"
        echo "$eval_warns"
        echo "Please fix these and squash into your existing commits"
        exit 1
      fi
